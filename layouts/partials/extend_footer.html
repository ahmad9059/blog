<!-- Search Modal -->
<div id="searchModal" class="search-modal">
<div class="search-modal-content">
<div class="search-input-wrapper">
<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
<input type="text" id="searchModalInput" placeholder="Search..." autocomplete="off">
<span class="search-kbd">ESC</span>
</div>
<div id="searchModalResults" class="search-results"></div>
</div>
</div>

<style>
.search-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 9999;
  justify-content: center;
  align-items: flex-start;
  padding-top: 10vh;
}
.search-modal.active {
  display: flex;
}
.search-modal-content {
  width: 100%;
  max-width: 480px;
  margin: 0 1rem;
}
.search-input-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--entry);
  border-radius: 10px;
  padding: 12px 16px;
  border: 1px solid var(--border);
}
.search-input-wrapper svg {
  color: var(--secondary);
  flex-shrink: 0;
}
#searchModalInput {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 16px;
  color: var(--primary);
  outline: none;
}
#searchModalInput::placeholder {
  color: var(--secondary);
}
.search-kbd {
  font-size: 11px;
  color: var(--secondary);
  background: var(--code-bg);
  padding: 3px 8px;
  border-radius: 4px;
}
.search-results {
  margin-top: 8px;
  background: var(--entry);
  border-radius: 10px;
  border: 1px solid var(--border);
  overflow: hidden;
  display: none;
}
.search-results.show {
  display: block;
}
.search-results a {
  display: block;
  padding: 12px 16px;
  color: var(--primary);
  text-decoration: none;
  border-bottom: 1px solid var(--border);
  font-size: 14px;
}
.search-results a:last-child {
  border-bottom: none;
}
.search-results a:hover,
.search-results a.focus {
  background: var(--code-bg);
}
.search-results .no-results {
  padding: 12px 16px;
  color: var(--secondary);
  font-size: 14px;
}
</style>

<script>
(function() {
  const modal = document.getElementById('searchModal');
  const input = document.getElementById('searchModalInput');
  const results = document.getElementById('searchModalResults');
  let fuse = null, focus = -1, fuseLoading = false;

  function loadFuse() {
    if (fuse || fuseLoading) return;
    fuseLoading = true;
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js';
    s.onload = function() {
      fetch('/index.json').then(r => r.json()).then(data => {
        fuse = new Fuse(data, { keys: ['title'], threshold: 0.3 });
        if (input.value.trim()) search(input.value);
      });
    };
    document.head.appendChild(s);
  }

  window.openSearchModal = function() {
    modal.classList.add('active');
    input.focus();
    document.body.style.overflow = 'hidden';
    loadFuse();
  };

  function close() {
    modal.classList.remove('active');
    input.value = '';
    results.innerHTML = '';
    results.classList.remove('show');
    document.body.style.overflow = '';
    focus = -1;
  }

  function search(q) {
    if (!fuse || !q.trim()) {
      results.innerHTML = '';
      results.classList.remove('show');
      return;
    }
    const r = fuse.search(q, { limit: 6 });
    if (!r.length) {
      results.innerHTML = '<div class="no-results">No results</div>';
      results.classList.add('show');
      return;
    }
    results.innerHTML = r.map(x => `<a href="${x.item.permalink}">${x.item.title}</a>`).join('');
    results.classList.add('show');
    focus = -1;
  }

  function nav(d) {
    const items = results.querySelectorAll('a');
    if (!items.length) return;
    items.forEach(i => i.classList.remove('focus'));
    focus += d;
    if (focus >= items.length) focus = 0;
    if (focus < 0) focus = items.length - 1;
    items[focus].classList.add('focus');
  }

  input.addEventListener('input', () => search(input.value));
  modal.addEventListener('click', e => { if (e.target === modal) close(); });

  document.addEventListener('keydown', e => {
    if ((e.ctrlKey && e.key === 'k') || (e.key === '/' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName))) {
      e.preventDefault();
      openSearchModal();
    }
    if (!modal.classList.contains('active')) return;
    if (e.key === 'Escape') close();
    else if (e.key === 'ArrowDown') { e.preventDefault(); nav(1); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); nav(-1); }
    else if (e.key === 'Enter') {
      const f = results.querySelector('a.focus') || results.querySelector('a');
      if (f) f.click();
    }
  });
})();
</script>
